<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SevenPens Pen3DSim</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
<div id="control-panel">
    <h1>SevenPens Pen3DSim</h1>
    <div class="control-group">
        <label>Z: (Hover distance): <span class="slider-value"><span id="distance-value">0.00</span> in</span></label>
        <input type="range" id="pen-distance" min="0" max="1" step="0.05" value="0">
    </div>

    <div class="control-group">
        <label>X: <span class="slider-value"><span id="tablet-position-x-value">8.0</span> in</span></label>
        <input type="range" id="tablet-position-x" min="0" max="16" step="0.1" value="8">
    </div>

    <div class="control-group">
        <label>Y: <span class="slider-value"><span id="tablet-position-z-value">4.5</span> in</span></label>
        <input type="range" id="tablet-position-z" min="0" max="9" step="0.1" value="4.5">
    </div>

    <div class="control-group">
        <label>Tilt altitude: <span class="slider-value"><span id="altitude-value">0</span>°</span></label>
        <input type="range" id="tilt-altitude" min="0" max="60" step="1" value="0">
    </div>

    <div class="control-group">
        <label>Tilt azimuth: <span class="slider-value"><span id="azimuth-value">0</span>°</span></label>
        <input type="range" id="tilt-azimuth" min="0" max="359" step="1" value="0">
    </div>

    <div class="control-group">
        <label>Barrel rotation: <span class="slider-value"><span id="barrel-rotation-value">0</span>°</span></label>
        <input type="range" id="barrel-rotation" min="0" max="359" step="1" value="0">
    </div>
    
    <div class="control-group">
        <label>Tilt X: <span class="slider-value"><span id="tilt-x-value">0.0</span>°</span></label>
    </div>

    <div class="control-group">
        <label>Tilt Y: <span class="slider-value"><span id="tilt-y-value">0.0</span>°</span></label>
    </div>



    <div class="control-group">
        <label>Cursor X offset: <span class="slider-value"><span id="cursor-offset-x-value">0.00</span> in</span></label>
        <input type="range" id="cursor-offset-x" min="-5" max="5" step="0.05" value="0">
    </div>

    <div class="control-group">
        <label>Cursor Y offset: <span class="slider-value"><span id="cursor-offset-y-value">0.00</span> in</span></label>
        <input type="range" id="cursor-offset-y" min="-5" max="5" step="0.05" value="0">
    </div>

    <button id="annotations-flyout-btn" class="flyout-trigger-btn">Annotations</button>
    
    <div class="checkbox-grid">
        <div class="control-group">
            <label style="display: flex; align-items: center; gap: 8px;">
                <input type="checkbox" id="axonometric-view" style="width: auto; margin: 0;">
                <span>Axonometric</span>
            </label>
        </div>
    </div>

    <!-- Annotations Flyout -->
    <div id="annotations-flyout" class="flyout-panel">
        <div class="flyout-header">
            <h3>Annotations</h3>
            <button id="annotations-flyout-close" class="flyout-close-btn">×</button>
        </div>
        <div class="flyout-content">
            <div style="display: flex; gap: 8px; margin-bottom: 12px;">
                <button id="annotations-all-on-btn" class="flyout-button" style="flex: 1;">All On</button>
                <button id="annotations-all-off-btn" class="flyout-button" style="flex: 1;">All Off</button>
            </div>
            
            <div class="control-group">
                <label style="display: flex; align-items: center; gap: 8px;">
                    <input type="checkbox" id="altitude-annotations" style="width: auto; margin: 0;">
                    <span>Tilt altitude</span>
                </label>
            </div>

            <div class="control-group">
                <label style="display: flex; align-items: center; gap: 8px;">
                    <input type="checkbox" id="azimuth-annotations" style="width: auto; margin: 0;">
                    <span>Tilt azimuth</span>
                </label>
            </div>

            <div class="control-group">
                <label style="display: flex; align-items: center; gap: 8px;">
                    <input type="checkbox" id="tilt-x-annotations" style="width: auto; margin: 0;">
                    <span>Tilt X</span>
                </label>
            </div>

            <div class="control-group">
                <label style="display: flex; align-items: center; gap: 8px;">
                    <input type="checkbox" id="tilt-y-annotations" style="width: auto; margin: 0;">
                    <span>Tilt Y</span>
                </label>
            </div>

            <div class="control-group">
                <label style="display: flex; align-items: center; gap: 8px;">
                    <input type="checkbox" id="barrel-annotations" style="width: auto; margin: 0;">
                    <span>Barrel rotation</span>
                </label>
            </div>

            <div class="control-group">
                <label style="display: flex; align-items: center; gap: 8px;">
                    <input type="checkbox" id="axis-markers" style="width: auto; margin: 0;">
                    <span>Axis</span>
                </label>
            </div>

            <div class="control-group">
                <label style="display: flex; align-items: center; gap: 8px;">
                    <input type="checkbox" id="cursor-visible" style="width: auto; margin: 0;" checked>
                    <span>Mouse cursor</span>
                </label>
            </div>

            <div class="control-group">
                <label style="display: flex; align-items: center; gap: 8px;">
                    <input type="checkbox" id="pen-shadow-visible" style="width: auto; margin: 0;" checked>
                    <span>Pen shadow</span>
                </label>
            </div>

            <div class="control-group">
                <label style="display: flex; align-items: center; gap: 8px;">
                    <input type="checkbox" id="tablet-checkerboard" style="width: auto; margin: 0;">
                    <span>Tablet checkerboard</span>
                </label>
            </div>
        </div>
    </div>

    <button id="reset-btn">Reset pen</button>
    <button id="animations-flyout-btn" class="flyout-trigger-btn">Animations</button>
    <button id="edit-view-btn">Edit View</button>
    <button id="export-btn">Export as PNG</button>

    <!-- Animations Flyout -->
    <div id="animations-flyout" class="flyout-panel">
        <div class="flyout-header">
            <h3>Animations</h3>
            <button id="animations-flyout-close" class="flyout-close-btn">×</button>
        </div>
        <div class="flyout-content">
            <button id="demo-btn" class="flyout-button">Demo</button>
            <button id="anim-btn" class="flyout-button">Anim Rot all</button>
            <button id="anim-tilt-altitude-btn" class="flyout-button">Anim Tilt Altitude</button>
            <button id="anim-tilt-azimuth-btn" class="flyout-button">Anim Tilt Azimuth</button>
            <button id="anim-barrel-btn" class="flyout-button">Anim Barrel</button>
        </div>
    </div>
</div>
<div id="viewer">
</div>

<!-- Modal for editing camera settings -->
<div id="camera-edit-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.7); z-index: 1000; justify-content: center; align-items: center; flex-direction: column;">
    <div style="background: #2d2d2d; padding: 20px; border-radius: 8px; width: 600px; max-width: 90%; max-height: 90%; display: flex; flex-direction: column; box-sizing: border-box;">
        <h2 style="color: #fff; margin-bottom: 15px; margin-top: 0;">Edit Camera Settings</h2>
        <textarea id="camera-json-editor" style="width: 100%; height: 400px; font-family: monospace; font-size: 12px; background: #1a1a1a; color: #fff; border: 1px solid #444; padding: 10px; border-radius: 4px; resize: vertical; flex: 1; min-height: 300px; box-sizing: border-box;"></textarea>
        <div style="display: flex; gap: 10px; margin-top: 15px; justify-content: flex-end;">
            <button id="camera-edit-cancel" style="padding: 8px 20px; background: #666; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;">CANCEL</button>
            <button id="camera-edit-ok" style="padding: 8px 20px; background: #4CAF50; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px; font-weight: bold;">OK</button>
        </div>
    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
<script src="materials.js"></script>
<script src="textures.js"></script>
<script src="pen3dsim.js"></script>
<script src="animations.js"></script>
<script>
    // Initialize Pen3DSim
    const viewer = document.getElementById('viewer');
    const sim = new Pen3DSim(viewer);
    
    // UI Event Handlers
    // Pen distance slider
    const penDistanceSlider = document.getElementById('pen-distance');
    const distanceValueDisplay = document.getElementById('distance-value');

    penDistanceSlider.addEventListener('input', (e) => {
        const distance = parseFloat(e.target.value);
        distanceValueDisplay.textContent = distance.toFixed(2);
        sim.setDistance(distance);
    });

        // Barrel rotation slider
        const barrelRotationSlider = document.getElementById('barrel-rotation');
        const barrelRotationValueDisplay = document.getElementById('barrel-rotation-value');

        barrelRotationSlider.addEventListener('input', (e) => {
        const barrelRotation = parseFloat(e.target.value);
            barrelRotationValueDisplay.textContent = barrelRotation.toFixed(0);
        sim.setBarrelRotation(barrelRotation);
        });

    // Tilt azimuth slider
    const tiltAzimuthSlider = document.getElementById('tilt-azimuth');
    const azimuthValueDisplay = document.getElementById('azimuth-value');

    // Function to update azimuth slider enabled state based on altitude
    function updateAzimuthSliderState() {
        const tiltAltitude = parseFloat(document.getElementById('tilt-altitude').value);
        if (tiltAltitude === 0) {
            tiltAzimuthSlider.disabled = true;
            tiltAzimuthSlider.style.opacity = '0.5';
            tiltAzimuthSlider.style.cursor = 'not-allowed';
        } else {
            tiltAzimuthSlider.disabled = false;
            tiltAzimuthSlider.style.opacity = '1';
            tiltAzimuthSlider.style.cursor = 'pointer';
        }
    }

    tiltAzimuthSlider.addEventListener('input', (e) => {
        const tiltAzimuth = parseFloat(e.target.value);
        azimuthValueDisplay.textContent = tiltAzimuth.toFixed(0);
        const result = sim.setTiltAzimuth(tiltAzimuth);
        document.getElementById('tilt-x-value').textContent = result.tiltX.toFixed(1);
        document.getElementById('tilt-y-value').textContent = result.tiltY.toFixed(1);
    });

    // Tilt altitude slider
    const tiltAltitudeSlider = document.getElementById('tilt-altitude');
    const altitudeValueDisplay = document.getElementById('altitude-value');

    tiltAltitudeSlider.addEventListener('input', (e) => {
        const tiltAltitude = parseFloat(e.target.value);
        altitudeValueDisplay.textContent = tiltAltitude.toFixed(0);
        updateAzimuthSliderState();
        const result = sim.setTiltAltitude(tiltAltitude);
        document.getElementById('tilt-x-value').textContent = result.tiltX.toFixed(1);
        document.getElementById('tilt-y-value').textContent = result.tiltY.toFixed(1);
    });
    
    // Initialize azimuth slider state
    updateAzimuthSliderState();

    // Tablet position sliders
    const tabletPositionXSlider = document.getElementById('tablet-position-x');
    const tabletPositionXValueDisplay = document.getElementById('tablet-position-x-value');
    const tabletPositionZSlider = document.getElementById('tablet-position-z');
    const tabletPositionZValueDisplay = document.getElementById('tablet-position-z-value');

    tabletPositionXSlider.addEventListener('input', (e) => {
        const tabletX = parseFloat(e.target.value);
        tabletPositionXValueDisplay.textContent = tabletX.toFixed(1);
        sim.setTabletPositionX(tabletX);
    });

    tabletPositionZSlider.addEventListener('input', (e) => {
        const tabletZ = parseFloat(e.target.value);
        tabletPositionZValueDisplay.textContent = tabletZ.toFixed(1);
        sim.setTabletPositionZ(tabletZ);
    });
    
    // Cursor offset sliders
    const cursorOffsetXSlider = document.getElementById('cursor-offset-x');
    const cursorOffsetXValueDisplay = document.getElementById('cursor-offset-x-value');
    const cursorOffsetYSlider = document.getElementById('cursor-offset-y');
    const cursorOffsetYValueDisplay = document.getElementById('cursor-offset-y-value');
    
    cursorOffsetXSlider.addEventListener('input', (e) => {
        const cursorOffsetX = parseFloat(e.target.value);
        cursorOffsetXValueDisplay.textContent = cursorOffsetX.toFixed(2);
        sim.setCursorOffsetX(cursorOffsetX);
    });
    
    cursorOffsetYSlider.addEventListener('input', (e) => {
        const cursorOffsetY = parseFloat(e.target.value);
        cursorOffsetYValueDisplay.textContent = cursorOffsetY.toFixed(2);
        sim.setCursorOffsetY(cursorOffsetY);
    });
    
    // Handle window resize
    window.addEventListener('resize', () => {
        sim.onResize();
    });
    
    // Axonometric view checkbox
    const axonometricCheckbox = document.getElementById('axonometric-view');
    axonometricCheckbox.addEventListener('change', (e) => {
        sim.setAxonometricView(e.target.checked);
    });
    
    // Tilt azimuth annotations visibility checkbox
    const azimuthAnnotationsCheckbox = document.getElementById('azimuth-annotations');
    sim.setAzimuthAnnotationsVisible(azimuthAnnotationsCheckbox.checked);
    azimuthAnnotationsCheckbox.addEventListener('change', (e) => {
        sim.setAzimuthAnnotationsVisible(e.target.checked);
    });
    
    // Tilt altitude annotations visibility checkbox
    const altitudeAnnotationsCheckbox = document.getElementById('altitude-annotations');
    altitudeAnnotationsCheckbox.addEventListener('change', (e) => {
        sim.setAltitudeAnnotationsVisible(e.target.checked);
    });
    
    // Barrel rotation annotations visibility checkbox
    const barrelAnnotationsCheckbox = document.getElementById('barrel-annotations');
    barrelAnnotationsCheckbox.addEventListener('change', (e) => {
        sim.setBarrelAnnotationsVisible(e.target.checked);
    });
    
    // Tilt X annotations visibility checkbox
    const tiltXAnnotationsCheckbox = document.getElementById('tilt-x-annotations');
    tiltXAnnotationsCheckbox.addEventListener('change', (e) => {
        sim.setTiltXAnnotationsVisible(e.target.checked);
    });
    
    // Tilt Y annotations visibility checkbox
    const tiltYAnnotationsCheckbox = document.getElementById('tilt-y-annotations');
    tiltYAnnotationsCheckbox.addEventListener('change', (e) => {
        sim.setTiltYAnnotationsVisible(e.target.checked);
    });
    
    // Axis markers visibility checkbox
    const axisMarkersCheckbox = document.getElementById('axis-markers');
    sim.setAxisMarkersVisible(axisMarkersCheckbox.checked);
    axisMarkersCheckbox.addEventListener('change', (e) => {
        sim.setAxisMarkersVisible(e.target.checked);
    });
    
    // Cursor visibility checkbox
    const cursorVisibleCheckbox = document.getElementById('cursor-visible');
    sim.setCursorVisible(cursorVisibleCheckbox.checked);
    cursorVisibleCheckbox.addEventListener('change', (e) => {
        sim.setCursorVisible(e.target.checked);
    });
    
    // Pen shadow visibility checkbox
    const penShadowVisibleCheckbox = document.getElementById('pen-shadow-visible');
    sim.setPenShadowVisible(penShadowVisibleCheckbox.checked);
    penShadowVisibleCheckbox.addEventListener('change', (e) => {
        sim.setPenShadowVisible(e.target.checked);
    });
    
    // Tablet checkerboard checkbox
    const tabletCheckerboardCheckbox = document.getElementById('tablet-checkerboard');
    sim.setTabletCheckerboardVisible(tabletCheckerboardCheckbox.checked);
    tabletCheckerboardCheckbox.addEventListener('change', (e) => {
        sim.setTabletCheckerboardVisible(e.target.checked);
    });
    
    // All annotations on/off buttons
    document.getElementById('annotations-all-on-btn').addEventListener('click', () => {
        altitudeAnnotationsCheckbox.checked = true;
        azimuthAnnotationsCheckbox.checked = true;
        tiltXAnnotationsCheckbox.checked = true;
        tiltYAnnotationsCheckbox.checked = true;
        barrelAnnotationsCheckbox.checked = true;
        axisMarkersCheckbox.checked = true;
        cursorVisibleCheckbox.checked = true;
        penShadowVisibleCheckbox.checked = true;
        
        sim.setAltitudeAnnotationsVisible(true);
        sim.setAzimuthAnnotationsVisible(true);
        sim.setTiltXAnnotationsVisible(true);
        sim.setTiltYAnnotationsVisible(true);
        sim.setBarrelAnnotationsVisible(true);
        sim.setAxisMarkersVisible(true);
        sim.setCursorVisible(true);
        sim.setPenShadowVisible(true);
    });
    
    document.getElementById('annotations-all-off-btn').addEventListener('click', () => {
        altitudeAnnotationsCheckbox.checked = false;
        azimuthAnnotationsCheckbox.checked = false;
        tiltXAnnotationsCheckbox.checked = false;
        tiltYAnnotationsCheckbox.checked = false;
        barrelAnnotationsCheckbox.checked = false;
        axisMarkersCheckbox.checked = false;
        cursorVisibleCheckbox.checked = false;
        penShadowVisibleCheckbox.checked = false;
        
        sim.setAltitudeAnnotationsVisible(false);
        sim.setAzimuthAnnotationsVisible(false);
        sim.setTiltXAnnotationsVisible(false);
        sim.setTiltYAnnotationsVisible(false);
        sim.setBarrelAnnotationsVisible(false);
        sim.setAxisMarkersVisible(false);
        sim.setCursorVisible(false);
        sim.setPenShadowVisible(false);
    });
    
    // Reset pen button
    document.getElementById('reset-btn').addEventListener('click', () => {
        const defaults = sim.reset();
        
        // Update sliders
        penDistanceSlider.value = defaults.distance;
        tiltAltitudeSlider.value = defaults.tiltAltitude;
        tiltAzimuthSlider.value = defaults.tiltAzimuth;
        barrelRotationSlider.value = defaults.barrelRotation;
        tabletPositionXSlider.value = defaults.tabletX;
        tabletPositionZSlider.value = defaults.tabletZ;
        
        // Update displays
        distanceValueDisplay.textContent = defaults.distance.toFixed(2);
        altitudeValueDisplay.textContent = defaults.tiltAltitude.toFixed(0);
        azimuthValueDisplay.textContent = defaults.tiltAzimuth.toFixed(0);
        barrelRotationValueDisplay.textContent = defaults.barrelRotation.toFixed(0);
        tabletPositionXValueDisplay.textContent = defaults.tabletX.toFixed(1);
        tabletPositionZValueDisplay.textContent = defaults.tabletZ.toFixed(1);
        
        // Update azimuth slider state
        updateAzimuthSliderState();
        
        // Update pen transform
        sim.setDistance(defaults.distance);
        sim.setTiltAltitude(defaults.tiltAltitude);
        sim.setTiltAzimuth(defaults.tiltAzimuth);
        sim.setBarrelRotation(defaults.barrelRotation);
        sim.setTabletPositionX(defaults.tabletX);
        sim.setTabletPositionZ(defaults.tabletZ);
    });
    
    // Get flyout references early (needed for button handlers)
    const animationsFlyout = document.getElementById('animations-flyout');
    
    // Demo button
    document.getElementById('demo-btn').addEventListener('click', () => {
        // Close animations flyout immediately
        if (animationsFlyout && animationsFlyout.classList.contains('open')) {
            animationsFlyout.classList.remove('open');
        }
        
        // Demo values: distance=0, tabletX=8.6, tabletZ=5.3, altitude=45, azimuth=242, barrelRotation=318
        const demoDistance = 0;
        const demoTiltAltitude = 45;
        const demoTiltAzimuth = 242;
        const demoBarrelRotation = 318;
        const demoTabletX = 8.6;
        const demoTabletZ = 5.3;
        
        // Update sliders
        penDistanceSlider.value = demoDistance;
        tiltAltitudeSlider.value = demoTiltAltitude;
        tiltAzimuthSlider.value = demoTiltAzimuth;
        barrelRotationSlider.value = demoBarrelRotation;
        tabletPositionXSlider.value = demoTabletX;
        tabletPositionZSlider.value = demoTabletZ;
        
        // Update displays
        distanceValueDisplay.textContent = demoDistance.toFixed(2);
        altitudeValueDisplay.textContent = demoTiltAltitude.toFixed(0);
        azimuthValueDisplay.textContent = demoTiltAzimuth.toFixed(0);
        barrelRotationValueDisplay.textContent = demoBarrelRotation.toFixed(0);
        tabletPositionXValueDisplay.textContent = demoTabletX.toFixed(1);
        tabletPositionZValueDisplay.textContent = demoTabletZ.toFixed(1);
        
        // Update azimuth slider state
        updateAzimuthSliderState();
        
        // Enable annotations: altitude, azimuth, tilt X, tilt Y, and barrel rotation
        document.getElementById('altitude-annotations').checked = true;
        document.getElementById('azimuth-annotations').checked = true;
        document.getElementById('tilt-x-annotations').checked = true;
        document.getElementById('tilt-y-annotations').checked = true;
        document.getElementById('barrel-annotations').checked = true;
        
        // Update pen transform and annotations
        sim.setDistance(demoDistance);
        sim.setTiltAltitude(demoTiltAltitude);
        sim.setTiltAzimuth(demoTiltAzimuth);
        sim.setBarrelRotation(demoBarrelRotation);
        sim.setTabletPositionX(demoTabletX);
        sim.setTabletPositionZ(demoTabletZ);
        sim.setAltitudeAnnotationsVisible(true);
        sim.setAzimuthAnnotationsVisible(true);
        sim.setTiltXAnnotationsVisible(true);
        sim.setTiltYAnnotationsVisible(true);
        sim.setBarrelAnnotationsVisible(true);
        
        // Update tilt X and Y displays
        const tiltResult = sim.setTiltAzimuth(demoTiltAzimuth);
        document.getElementById('tilt-x-value').textContent = tiltResult.tiltX.toFixed(1);
        document.getElementById('tilt-y-value').textContent = tiltResult.tiltY.toFixed(1);
    });
    
    // Anim button
    let cancelAnimation = null;
    document.getElementById('anim-btn').addEventListener('click', () => {
        // Close animations flyout immediately
        if (animationsFlyout && animationsFlyout.classList.contains('open')) {
            animationsFlyout.classList.remove('open');
        }
        
        // Cancel any existing animation
        if (cancelAnimation) {
            cancelAnimation();
        }
        
        // Wait 0.5 seconds before starting animation
        setTimeout(() => {
            // Enable annotations at the start of animation
            document.getElementById('altitude-annotations').checked = true;
            document.getElementById('azimuth-annotations').checked = true;
            // document.getElementById('tilt-x-annotations').checked = true;
            // document.getElementById('tilt-y-annotations').checked = true;
            document.getElementById('barrel-annotations').checked = true;
            
            sim.setAltitudeAnnotationsVisible(true);
            sim.setAzimuthAnnotationsVisible(true);
            // sim.setTiltXAnnotationsVisible(true);
            // sim.setTiltYAnnotationsVisible(true);
            sim.setBarrelAnnotationsVisible(true);
            
            // Reset to default position first
            const defaults = sim.reset();
            
            // Update sliders and displays to defaults
            penDistanceSlider.value = defaults.distance;
            tiltAltitudeSlider.value = defaults.tiltAltitude;
            tiltAzimuthSlider.value = defaults.tiltAzimuth;
            barrelRotationSlider.value = defaults.barrelRotation;
            tabletPositionXSlider.value = defaults.tabletX;
            tabletPositionZSlider.value = defaults.tabletZ;
            
            distanceValueDisplay.textContent = defaults.distance.toFixed(2);
            altitudeValueDisplay.textContent = defaults.tiltAltitude.toFixed(0);
            azimuthValueDisplay.textContent = defaults.tiltAzimuth.toFixed(0);
            barrelRotationValueDisplay.textContent = defaults.barrelRotation.toFixed(0);
            tabletPositionXValueDisplay.textContent = defaults.tabletX.toFixed(1);
            tabletPositionZValueDisplay.textContent = defaults.tabletZ.toFixed(1);
            
            updateAzimuthSliderState();
            
            // Set initial state
            sim.setDistance(defaults.distance);
            sim.setTiltAltitude(defaults.tiltAltitude);
            sim.setTiltAzimuth(defaults.tiltAzimuth);
            sim.setBarrelRotation(defaults.barrelRotation);
            sim.setTabletPositionX(defaults.tabletX);
            sim.setTabletPositionZ(defaults.tabletZ);
            
            // Start animation
            cancelAnimation = sim.animateToDemo((current, progress) => {
            // Update sliders and displays during animation
            penDistanceSlider.value = current.distance;
            tiltAltitudeSlider.value = current.tiltAltitude;
            tiltAzimuthSlider.value = current.tiltAzimuth;
            barrelRotationSlider.value = current.barrelRotation;
            tabletPositionXSlider.value = current.tabletX;
            tabletPositionZSlider.value = current.tabletZ;
            
            distanceValueDisplay.textContent = current.distance.toFixed(2);
            altitudeValueDisplay.textContent = Math.round(current.tiltAltitude);
            azimuthValueDisplay.textContent = Math.round(current.tiltAzimuth);
            barrelRotationValueDisplay.textContent = Math.round(current.barrelRotation);
            tabletPositionXValueDisplay.textContent = current.tabletX.toFixed(1);
            tabletPositionZValueDisplay.textContent = current.tabletZ.toFixed(1);
            
            // Update tilt X and Y displays
            const tiltResult = sim.setTiltAzimuth(current.tiltAzimuth);
            document.getElementById('tilt-x-value').textContent = tiltResult.tiltX.toFixed(1);
            document.getElementById('tilt-y-value').textContent = tiltResult.tiltY.toFixed(1);
            
            // Clean up when animation completes
            if (progress >= 1) {
                cancelAnimation = null;
            }
        });
        }, 500);
    });

    // Export as PNG
    document.getElementById('export-btn').addEventListener('click', () => {
        sim.exportAsPNG();
    });
    
    // Initialize animation handlers
    initializeAnimations(sim, {
        tiltAzimuthSlider,
        tiltAltitudeSlider,
        barrelRotationSlider,
        altitudeValueDisplay,
        azimuthValueDisplay,
        barrelRotationValueDisplay,
        updateAzimuthSliderState,
        animationsFlyout
    });
    
    // Edit View button and modal
    const editViewBtn = document.getElementById('edit-view-btn');
    const cameraEditModal = document.getElementById('camera-edit-modal');
    const cameraJsonEditor = document.getElementById('camera-json-editor');
    const cameraEditOk = document.getElementById('camera-edit-ok');
    const cameraEditCancel = document.getElementById('camera-edit-cancel');
    
    // Show modal when Edit View button is clicked
    editViewBtn.addEventListener('click', () => {
        try {
            const jsonSettings = sim.getCameraSettingsJSON();
            cameraJsonEditor.value = jsonSettings;
            cameraEditModal.style.display = 'flex';
            cameraJsonEditor.focus();
        } catch (error) {
            alert(`Error loading camera settings: ${error.message}`);
        }
    });
    
    // Close modal when Cancel is clicked
    cameraEditCancel.addEventListener('click', () => {
        cameraEditModal.style.display = 'none';
    });
    
    // Close modal when clicking outside the modal content
    cameraEditModal.addEventListener('click', (e) => {
        if (e.target === cameraEditModal) {
            cameraEditModal.style.display = 'none';
        }
    });
    
    // Apply settings when OK is clicked
    cameraEditOk.addEventListener('click', () => {
        try {
            const jsonText = cameraJsonEditor.value;
            sim.setCameraSettingsJSON(jsonText);
            cameraEditModal.style.display = 'none';
        } catch (error) {
            alert(`Error applying camera settings: ${error.message}`);
        }
    });
    
    // Annotations and Animations flyout toggles
    const annotationsFlyoutBtn = document.getElementById('annotations-flyout-btn');
    const annotationsFlyout = document.getElementById('annotations-flyout');
    const annotationsFlyoutClose = document.getElementById('annotations-flyout-close');
    const animationsFlyoutBtn = document.getElementById('animations-flyout-btn');
    const animationsFlyoutClose = document.getElementById('animations-flyout-close');
    
    annotationsFlyoutBtn.addEventListener('click', () => {
        // Close animations flyout if open
        if (animationsFlyout.classList.contains('open')) {
            animationsFlyout.classList.remove('open');
        }
        annotationsFlyout.classList.toggle('open');
    });
    
    annotationsFlyoutClose.addEventListener('click', () => {
        annotationsFlyout.classList.remove('open');
    });
    
    animationsFlyoutBtn.addEventListener('click', () => {
        // Close annotations flyout if open
        if (annotationsFlyout.classList.contains('open')) {
            annotationsFlyout.classList.remove('open');
        }
        animationsFlyout.classList.toggle('open');
    });
    
    animationsFlyoutClose.addEventListener('click', () => {
        animationsFlyout.classList.remove('open');
    });
    
    // Allow Escape key to close modal and flyouts
    document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
            if (cameraEditModal.style.display === 'flex') {
                cameraEditModal.style.display = 'none';
            }
            if (annotationsFlyout.classList.contains('open')) {
                annotationsFlyout.classList.remove('open');
            }
            if (animationsFlyout.classList.contains('open')) {
                animationsFlyout.classList.remove('open');
            }
        }
    });
    
    // Close flyouts when clicking outside
    document.addEventListener('click', (e) => {
        if (annotationsFlyout.classList.contains('open') && 
            !annotationsFlyout.contains(e.target) && 
            e.target !== annotationsFlyoutBtn) {
            annotationsFlyout.classList.remove('open');
        }
        if (animationsFlyout.classList.contains('open') && 
            !animationsFlyout.contains(e.target) && 
            e.target !== animationsFlyoutBtn) {
            animationsFlyout.classList.remove('open');
        }
    });
</script>
</body>
</html>
